/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package com.puntodeventa.mvc.Views;

import com.puntodeventa.global.Entity.AccesoForms;
import com.puntodeventa.global.Entity.Formularios;
import com.puntodeventa.global.Entity.Usuario;
import com.puntodeventa.global.Util.TagHelper;
import com.puntodeventa.global.Util.ValidacionForms;
import com.puntodeventa.mvc.Controller.AccesoFormsLogic;
import com.puntodeventa.mvc.Controller.FormularioLogic;
import com.puntodeventa.mvc.Controller.UsuarioLogic;
import java.awt.event.KeyEvent;
import java.util.List;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author Nato
 */


public class frmForms extends javax.swing.JDialog {

    private ValidacionForms valForm = new ValidacionForms();
    UsuarioLogic userLogic = new UsuarioLogic();
    AccesoFormsLogic accesoFormsLogic = new AccesoFormsLogic();
    FormularioLogic formularioLogic = new FormularioLogic();
    DefaultTableModel model = new DefaultTableModel();
    private PuntoVentaMDI parent;
    private Boolean BAN_ACCESO = false;
    private String ACCESO;
    private List<Usuario> listUser;
    private List<AccesoForms> listForms;
    private List<Formularios> listFormularios;
    private String NameClass = this.getClass().getSimpleName();

    /**
     * Creates new form frmForms
     */
    public frmForms(PuntoVentaMDI parent, boolean modal) {
        super(parent, modal);
        this.parent = parent;
        initComponents();
        this.setTitle(TagHelper.getTag("frmForms.title"));
    }
    private Usuario getUser(){
        Usuario usuario;
        usuario = userLogic.getUserSerializable();
        return usuario;
    }
    
    private boolean iniTable() {
        model = new DefaultTableModel() {
            /*
             * @Override public boolean isCellEditable(int row, int column) {
             * return false; }
             */

            Class[] types = new Class[]{
                Object.class, Object.class, Boolean.class
            };

            @Override
            public Class getColumnClass(int columnIndex) {
                return types[columnIndex];
            }
        };
        model.addColumn("CVE FORMA");
        model.addColumn("DESCRIPCION");
        model.addColumn("ACCESO");
        model.addColumn("ID");
        this.jtblForms.setModel(model);
        jScrollPane1.setViewportView(jtblForms);
        jtblForms.getColumnModel().getColumn(0).setMinWidth(0);
        jtblForms.getColumnModel().getColumn(0).setPreferredWidth(0);
        jtblForms.getColumnModel().getColumn(0).setMaxWidth(0);
        jtblForms.getColumnModel().getColumn(1).setMinWidth(580);
        jtblForms.getColumnModel().getColumn(1).setPreferredWidth(580);
        jtblForms.getColumnModel().getColumn(1).setMaxWidth(580);
        jtblForms.getColumnModel().getColumn(2).setMinWidth(80);
        jtblForms.getColumnModel().getColumn(2).setPreferredWidth(80);
        jtblForms.getColumnModel().getColumn(2).setMaxWidth(80);
        jtblForms.getColumnModel().getColumn(3).setMinWidth(0);
        jtblForms.getColumnModel().getColumn(3).setPreferredWidth(0);
        jtblForms.getColumnModel().getColumn(3).setMaxWidth(0);
        return true;
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jpnDataUser = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jtxtCve_usuario = new javax.swing.JTextField();
        jLabel2 = new javax.swing.JLabel();
        jtxtNombreUsuario = new javax.swing.JTextField();
        jPanel2 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        jtblForms = new javax.swing.JTable();
        jPanel3 = new javax.swing.JPanel();
        jbtnCommit = new javax.swing.JButton();
        jbtnExit = new javax.swing.JButton();
        jbtnNew = new javax.swing.JButton();
        jbtnSearch = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        jpnDataUser.setBorder(javax.swing.BorderFactory.createTitledBorder(null, "Usuario", javax.swing.border.TitledBorder.DEFAULT_JUSTIFICATION, javax.swing.border.TitledBorder.DEFAULT_POSITION, new java.awt.Font("Tahoma", 1, 12))); // NOI18N

        jLabel1.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel1.setText("Clave de Usuario:");

        jtxtCve_usuario.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyTyped(java.awt.event.KeyEvent evt) {
                jtxtCve_usuarioKeyTyped(evt);
            }
        });

        jLabel2.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel2.setText("Nombre:");

        javax.swing.GroupLayout jpnDataUserLayout = new javax.swing.GroupLayout(jpnDataUser);
        jpnDataUser.setLayout(jpnDataUserLayout);
        jpnDataUserLayout.setHorizontalGroup(
            jpnDataUserLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jpnDataUserLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jpnDataUserLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jLabel1, javax.swing.GroupLayout.DEFAULT_SIZE, 147, Short.MAX_VALUE))
                .addGap(18, 18, 18)
                .addGroup(jpnDataUserLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jtxtNombreUsuario, javax.swing.GroupLayout.DEFAULT_SIZE, 409, Short.MAX_VALUE)
                    .addComponent(jtxtCve_usuario))
                .addContainerGap(62, Short.MAX_VALUE))
        );
        jpnDataUserLayout.setVerticalGroup(
            jpnDataUserLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jpnDataUserLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jpnDataUserLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jtxtCve_usuario, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel1, javax.swing.GroupLayout.Alignment.TRAILING))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(jpnDataUserLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel2)
                    .addComponent(jtxtNombreUsuario, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder(null, "Privilegios de Sistema", javax.swing.border.TitledBorder.DEFAULT_JUSTIFICATION, javax.swing.border.TitledBorder.DEFAULT_POSITION, new java.awt.Font("Tahoma", 1, 12))); // NOI18N

        jtblForms.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "CVE FORMA", "DESCRIPCION", "ACCESO", "ID"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Boolean.class, java.lang.Object.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, true
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane1.setViewportView(jtblForms);
        jtblForms.getColumnModel().getColumn(0).setMinWidth(0);
        jtblForms.getColumnModel().getColumn(0).setPreferredWidth(0);
        jtblForms.getColumnModel().getColumn(0).setMaxWidth(0);
        jtblForms.getColumnModel().getColumn(1).setMinWidth(580);
        jtblForms.getColumnModel().getColumn(1).setPreferredWidth(580);
        jtblForms.getColumnModel().getColumn(1).setMaxWidth(580);
        jtblForms.getColumnModel().getColumn(2).setMinWidth(80);
        jtblForms.getColumnModel().getColumn(2).setPreferredWidth(80);
        jtblForms.getColumnModel().getColumn(2).setMaxWidth(80);
        jtblForms.getColumnModel().getColumn(3).setMinWidth(0);
        jtblForms.getColumnModel().getColumn(3).setPreferredWidth(0);
        jtblForms.getColumnModel().getColumn(3).setMaxWidth(0);

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jScrollPane1)
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 167, javax.swing.GroupLayout.PREFERRED_SIZE)
        );

        jPanel3.setBorder(javax.swing.BorderFactory.createBevelBorder(javax.swing.border.BevelBorder.RAISED));

        jbtnCommit.setIcon(new javax.swing.ImageIcon(getClass().getResource("/images/iconDone.png"))); // NOI18N
        jbtnCommit.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbtnCommitActionPerformed(evt);
            }
        });

        jbtnExit.setIcon(new javax.swing.ImageIcon(getClass().getResource("/images/iconCritical.png"))); // NOI18N
        jbtnExit.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbtnExitActionPerformed(evt);
            }
        });

        jbtnNew.setIcon(new javax.swing.ImageIcon(getClass().getResource("/images/new.gif"))); // NOI18N
        jbtnNew.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbtnNewActionPerformed(evt);
            }
        });

        jbtnSearch.setIcon(new javax.swing.ImageIcon(getClass().getResource("/images/buscar.png"))); // NOI18N
        jbtnSearch.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbtnSearchActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addComponent(jbtnNew)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jbtnSearch)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jbtnCommit)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jbtnExit)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jbtnCommit, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(jbtnExit, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel3Layout.createSequentialGroup()
                .addGap(0, 0, Short.MAX_VALUE)
                .addComponent(jbtnSearch, javax.swing.GroupLayout.PREFERRED_SIZE, 33, javax.swing.GroupLayout.PREFERRED_SIZE))
            .addComponent(jbtnNew, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jpnDataUser, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jpnDataUser, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jbtnSearchActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbtnSearchActionPerformed
        if (!"".equals(this.jtxtCve_usuario.getText())) {
            listUser = userLogic.getByCveUser(this.jtxtCve_usuario.getText());
            if (listUser != null) {
                for (Usuario user : listUser) {
                    this.jtxtCve_usuario.setText(user.getCve_usuario());
                    this.jtxtNombreUsuario.setText(user.getNombre());
                    listFormularios = formularioLogic.getAllFormularios();
                    listForms = accesoFormsLogic.selectFormByCveUser(user.getId_usuario());
                    if (listFormularios != null) {
                        if (true == iniTable()) {
                            for (Formularios f : listFormularios) {
                                for (AccesoForms af : listForms) {
                                    if (f.getCve_forma().equals(af.getCveForma())) {
                                        if (af.getAcceso().equals("S")) {
                                            BAN_ACCESO = true;
                                        } else {
                                            BAN_ACCESO = false;
                                        }
                                        model.addRow(new Object[]{f.getCve_forma(), f.getDescripcion(), BAN_ACCESO, af.getId()});
                                    }
                                }
                            }
                        }
                    }
                }
            } else {
                System.out.println("No elements");
                valForm.msjInfo(TagHelper.getTag("frmForms.searchIsNull"));
            }
        } else {
            valForm.msjInfo(TagHelper.getTag("frmForms.cveUserEmpty"));
        }
    }//GEN-LAST:event_jbtnSearchActionPerformed

    private void jbtnNewActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbtnNewActionPerformed
        try {
            valForm.cleanTable(jtblForms, model);
            valForm.cleanTextField(jpnDataUser);
            valForm.cleanTextField(this.jpnDataUser);
            this.jtxtCve_usuario.requestFocus();
        } catch (Exception ex) {
        }
    }//GEN-LAST:event_jbtnNewActionPerformed

    private void jtxtCve_usuarioKeyTyped(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jtxtCve_usuarioKeyTyped
        if (evt.getKeyChar() == KeyEvent.VK_ENTER) {
            this.jbtnSearch.doClick();
        }
    }//GEN-LAST:event_jtxtCve_usuarioKeyTyped

    private void jbtnCommitActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbtnCommitActionPerformed
        try {
            if (!this.jtxtCve_usuario.getText().equals("") && !this.jtxtNombreUsuario.getText().equals("") && jtblForms.getRowCount()> 0) {
                int id_usuario = 0;
                for (Usuario user : listUser) {
                    id_usuario = user.getId_usuario();
                }
                for (int i = 0; i < jtblForms.getRowCount(); i++) {
                    BAN_ACCESO = (Boolean) this.jtblForms.getValueAt(i, 2);
                    if (true == BAN_ACCESO) {
                        ACCESO = "S";
                    } else {
                        ACCESO = "N";
                    }
                    AccesoForms af = new AccesoForms();
                    af.setCveForma((String) this.jtblForms.getValueAt(i, 0).toString());
                    af.setId_usuario(id_usuario);
                    af.setId(Integer.parseInt(this.jtblForms.getValueAt(i, 3).toString()));
                    af.setAcceso(ACCESO);
                    accesoFormsLogic.SaveUpdateForms(af);
                }
                valForm.msjInfo(TagHelper.getTag("frmForms.commit"));
            }else{
                valForm.msjInfo(TagHelper.getTag("frmForms.isEmpty"));
            }            
        } catch (Exception ex) {
            System.out.println("Error: " + ex.getMessage());
        }
    }//GEN-LAST:event_jbtnCommitActionPerformed

    private void jbtnExitActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbtnExitActionPerformed
        try {
            int op = valForm.msjOption(TagHelper.getTag("frmForms.cancel"), TagHelper.getTag("frmForms.rollback.title.msj"));
            if (op == 0) {
                valForm.cleanTable(jtblForms, model);
                valForm.cleanTextField(jpnDataUser);
                this.setVisible(false);
            }
        } catch (Exception ex) {
        }            
    }//GEN-LAST:event_jbtnExitActionPerformed
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JButton jbtnCommit;
    private javax.swing.JButton jbtnExit;
    private javax.swing.JButton jbtnNew;
    private javax.swing.JButton jbtnSearch;
    private javax.swing.JPanel jpnDataUser;
    private javax.swing.JTable jtblForms;
    private javax.swing.JTextField jtxtCve_usuario;
    private javax.swing.JTextField jtxtNombreUsuario;
    // End of variables declaration//GEN-END:variables
}
